## CloudFormation

Started off CloudFormation with a guest instructor __Rohini Gaonkar, an AWS Sr. Dev__ Advocate leading instruction along with Andrew. We walked through setting up a basic CloudFormation template deploying an ECS Cluster. We also created a deploy script that deployed the cluster, along with a new S3 bucket named cfn-artifacts-1. In addition to this, we add a task to our .gitpod.yml file to install cfn-lint. Per ChatGPT, "cfn-lint is a tool used for linting CloudFormation templates, which checks for syntactical errors, best practices, and adherence to standards. It ensures the correctness and quality of the CloudFormation template."

![Screenshot 2024-03-03 050143](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/07dbf30e-5cfb-4b6c-8759-4502f195de08)

![Screenshot 2024-03-03 050154](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/49bca862-3f22-44dc-ae42-c691c69064d0)

![Screenshot 2024-03-03 051136](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/d54e182c-fe8c-4ece-a9b1-671ccb48d369)


![Screenshot 2024-03-03 071652](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/0d9a8d2e-2868-4bd3-bb0b-b2a42e8b194b)

![Screenshot 2024-03-03 172132](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/5b24d319-f257-4cce-9f28-c6f2db3d86bd)

![Screenshot 2024-03-03 221205](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/49602e32-4812-4abd-9159-0268203e477d)

# Networking Layer

Moving onto main instruction, we now have a cfn folder created in aws directory. We create a new folder within this directory named networking. Next we create a new file in this folder named template.yaml. We begin, just fleshing out the template.yaml, commenting what we're going to need.

```
AWSTemplateFormatVersion: 2010-09-09

# VPC
# IGW
# Route Tables
# Subnets
# Subnet A
# Subnet B
# Subnet C
```


We immediately consult AWS documentation for the VPC, which in CloudFormation is known as AWS::EC2::VPC.

```
AWSTemplateFormatVersion: 2010-09-09

# VPC
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
# IGW
# Route Tables
# Subnets
# Subnet A
# Subnet B
# Subnet C
```
  
In our ./bin/cfn directory, we create a new script named networking-deploy.

```
#! /usr/bin/env bash
set -e #stop the execution of the script if it fails

CFN_PATH="/workspace/aws-bootcamp-cruddur-2023/aws/cfn/networking/template.yaml"

cfn-lint $CFN_PATH 

aws cloudformation deploy \
    --stack-name "Cruddur" \
    --s3-bucket $CFN_BUCKET \
    --template-file $CFN_PATH \
    --no-execute-changeset \
    --capabilities CAPABILITY_NAMED_IAM

```
  
We set the value for a variable named CFN_PATH to the path for our template.yaml file for our network layer.

Next, we deploy a CloudFormation stack using the aws cloudformation deploy command. Here are the options and arguments used:

--stack-name: Specifies the name of the stack to create or update. In this case, it's set to "Cruddur".

--s3-bucket: Specifies the S3 bucket to upload the CloudFormation template to. The value of the CFN_BUCKET variable is expected to be set somewhere else in the script or in the environment.

--template-file: Specifies the path to the CloudFormation template file, which is set to the value of the CFN_PATH variable.

--no-execute-changeset: Indicates that the changeset created during the deployment should not be executed immediately. It allows you to review the changes before applying them.

--capabilities CAPABILITY_NAMED_IAM: Specifies the IAM capabilities required to create or update IAM resources in the CloudFormation stack. This capability is necessary when the template includes IAM resources.

```
export CFN_BUCKET="cfn-artifacts-1"
gp env CFN_BUCKET="cfn-artifacts-1"
```

![Screenshot 2024-03-03 082041](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/e7260560-ec95-4159-8f3c-8116e6a3ea11)

![Screenshot 2024-03-03 221621](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/16797595-d82e-452b-a9ef-a2f034c32919)



We have yet to fill in a value for the CidrBlock property in our networking template.yaml file.  https://cidr.xyz to determine what we'll use for our CIDR block for our VPC. this will determine the range of IP addresses that can be assigned to the resources within our VPC and also help us maintain higher availability of our resources.

![Screenshot 2024-03-11 145218](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/e92687d3-a0be-44e0-b1df-018bf64b87b1)

```
AWSTemplateFormatVersion: 2010-09-09

Resources: 
  VPC:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/26
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
```

![Screenshot 2024-03-04 145742](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/48254ca0-76d7-41e6-9294-50e5124f730a)



When the VPC completes, we found that AWS also automatically creates a route table for you. In sifting through the resources, we had a bit of trouble with our previous configuration resources showing in the console. To remedy this, we decide to name the VPC resource as well, so we add tags to our template.yaml.

```
 Tags:
        - Key: Name
          Value: CruddurVPC
```

This will name our VPC resource as CruddurVPC. The next resource we must create is an internet gateway. We go back to AWS documentation and look specifically for AWS::EC2::InternetGateway. There's no properties to set for an internet gateway other than tags, so we implement the code:

```
  IGW:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internetgateway.html
    Type: AWS::EC2::InternetGateway
    Properties: 
      Tags:
        - Key: Name
          Value: CruddurIGW
```


When we create an internet gateway, we also must tell our CFN template to attach it. We consult AWS documentation for AWS::EC2::VPCGatewayAttachment then begin specifying properties.

```
  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref IGW
```
  
You’ll note the !Ref function being used here. !Ref VPC and !Ref IGW are used for the VpcId and InternetGatewayId properties respectively to reference the VPC and IGW resources defined earlier in the template.

![ref](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/e30194f5-9249-4832-898d-11c66f3caec1)
  
Implementing a route table, which is responsible for directing network traffic for our VPC.

```
  RouteTable:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-routetable.html
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC 
      Tags:
        - Key: Name
          Value: CruddurRT
```

Next, we implement a route:

```
  RouteToIGW:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html
    Type: AWS::EC2::Route
    DependsOn: AttachIGW
    Properties:
      RouteTableId: !Ref RouteTable
      GatewayId: !Ref IGW
      DestinationCidrBlock: 0.0.0.0/0
```

Please bring your attention to the DependsOn property. This property indicates that RouteToIGW will not be created if AttachIGW does not exist. So if our gateway is not created, CloudFormation will not create our route either. The GatewayId property is returning the logical id of the internet gateway we'd like to use, so we point it towards our IGW gateway. We want our route going out to the internet, so we set the DestinationCidrBlock to 0.0.0.0/0. The reasoning is, 0.0.0.0/0 represents the entire IPv4 address space in CIDR notation.


We also implement a route for local as well, but we’re uncertain on the GatewayId:

```
  RouteToLocal:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html
    Type: AWS::EC2::Route
    DependsOn: AttachIGW
    Properties:
      RouteTableId: !Ref RouteTable
      GatewayId: "local"
      DestinationCidrBlock: 10.0.0.0/16
```

![image](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/10759a5a-0f25-4641-8049-2d96862aca35)

Error received: "The route identified by 10.0.0.0/16 already exists."
Action taken: Commented out route creation code, deleted CloudFormation stack in ROLLBACK_COMPLETE state, redeployed with VPC, internet gateway, and gateway attachment only.
Observation: Network ACL created automatically. NACLs act as stateless firewalls for subnet-level traffic control.
Tip: Ensure NACLs have outbound routes to avoid blocking internet access.


We uncomment the lines of code creating our route table and our RouteToIGW. Then, we again deploy our networking CFN template. When the changeset is created, we execute it from CFN. When we go back to EC2 to view our our new route table, it automatically created the route to local as well:

![image](https://github.com/bhanumalhotra123/aws-bootcamp-cruddur-2023/assets/144083659/5d64a896-4151-45c0-b9c3-13ee659418c0)


Since the route to local is already being created, we remove the commented lines of code creating that route. Next, we must create our subnets. We might decide that our database must sit privately, so in addition to our public subnets, we create private ones as well.

```
  SubnetPub1:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1a
      CidrBlock: 10.0.0.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: true # public subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPub1
  SubnetPub2:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1b
      CidrBlock: 10.0.4.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: true # public subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPub2  
  SubnetPub3:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1c
      CidrBlock: 10.0.8.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: true # public subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPub3
  SubnetPriv1:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1a
      CidrBlock: 10.0.12.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: false # private subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPriv1  
  SubnetPriv2:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1b
      CidrBlock: 10.0.16.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: false # private subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPriv2
  SubnetPriv3:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html
    Type: AWS::EC2::Subnet
    Properties:
      AssignIpv6AddressOnCreation: false
      AvailabilityZone: us-east-1c
      CidrBlock: 10.0.20.0/24
      EnableDns64: false
      MapPublicIpOnLaunch: false # private subnet
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: CruddurSubnetPriv3 
```

A few key takeaways from these properties:

AssignIpv6AddressOnCreation: controls whether IPV6 addresses are automatically assigned to instances that are launched in the subnet

AvailabilityZone: the availability zone within AWS that our subnet is created in

EnableDns64: controls whether DNS64 is enabled for an IPv6 enabled subnet. Since we're not using IPv6, this value is false

MapPublicIpOnLaunch: controls the automatic assignment of a public IP address to instances launched within a subnet. Notice our public subnets have this set to true, where our private ones are set to false.

Next we must implement our SubnetRouteTableAssocation resources. This will associate our subnets with our route table in the VPC.

